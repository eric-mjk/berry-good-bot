<!-- /behavior_trees/roughApproach_with_ibvs.xml -->
<root main_tree_to_execute="PickWithIBVS">
  <BehaviorTree ID="PickWithIBVS">
    <Sequence name="PickSequence">
      <!-- 1) 미리 자세 -->
      <MoveToNamedPose pose="ready"/>
      <WaitRealRobotSync tolerance="0.01" stable_time="5.5" timeout="30.0"/>

      <!-- (선택) 그리퍼 열어두기 -->
      <GripperAction mode="open" timeout="8.0"/>

      <!-- 2) 탐지 → 접근점(base_link) 산출, 블랙보드에 저장 -->
      <DetectApproachPose stage="1" offset_z="0.05"
                          ax="{appr_x}" ay="{appr_y}" az="{appr_z}"
                          qx="{appr_qx}" qy="{appr_qy}" qz="{appr_qz}" qw="{appr_qw}"
                          tx="{tar_x}" ty="{tar_y}" tz="{tar_z}"/>

      <!-- 3) 서보로 접근 (블랙보드 값 사용) -->
      <ServoToTargetPose ax="{appr_x}" ay="{appr_y}" az="{appr_z}"
                         qx="{appr_qx}" qy="{appr_qy}" qz="{appr_qz}" qw="{appr_qw}"
                         base_frame="base_link" tip_frame="link5"
                         kp_pos="0.8" kp_ori="1.2"
                         vmax_lin="0.2" vmin_lin="0.1"
                         vmax_ang="1.0"  vmin_ang="0.5"
                         pos_tol="0.01" ori_tol="0.05"
                         stable_time="0.5" timeout="40.0"/>

      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/>

      <!-- 4) 탐지 → 접근점(base_link) 산출, 블랙보드에 저장 -->
      <DetectApproachPose stage="2" offset_z="0.01"
                          prev_x="{tar_x}" prev_y="{tar_y}" prev_z="{tar_z}"
                          prev_gate_m="0.12"
                          ax="{appr_x}" ay="{appr_y}" az="{appr_z}"
                          qx="{appr_qx}" qy="{appr_qy}" qz="{appr_qz}" qw="{appr_qw}"
                          tx="{tar_x}" ty="{tar_y}" tz="{tar_z}"/>

      <!-- 5) 서보로 접근 (블랙보드 값 사용) -->
      <ServoToTargetPose ax="{appr_x}" ay="{appr_y}" az="{appr_z}"
                         qx="{appr_qx}" qy="{appr_qy}" qz="{appr_qz}" qw="{appr_qw}"
                         base_frame="base_link" tip_frame="link5"
                         kp_pos="0.8" kp_ori="1.2"
                         vmax_lin="0.2" vmin_lin="0.1"
                         vmax_ang="1.0"  vmin_ang="0.5"
                         pos_tol="0.01" ori_tol="0.05"
                         stable_time="0.5" timeout="40.0"/>

      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/>

      <!-- 5) ★ IBVS Visual Servoing (딸기 상/하 카메라 시각 서보) -->
      <!-- IBVS가 성공하면 fruit_class와 basket_pose를 블랙보드에 저장 -->
      <VisualServoing timeout="40.0" fruit_class="{fruit}" basket_pose="{basket_pose}"/>
 

      <!-- 6) 그리퍼 닫기 -->
      <!-- <GripperAction mode="close" timeout="8.0"/> -->

      <MoveToNamedPose pose="ready"/>
      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/>

      <!-- <GripperAction mode="close" timeout="8.0"/> -->
      
      <!-- 4) 장바구니로 이동(과일 타입별 바구니로 분기) -->
      <MoveToNamedPose pose="{basket_pose}"/>
      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/>
      <GripperAction mode="open" timeout="8.0"/>
      <!-- 떨어뜨린 뒤 살짝 대기 -->
      <WaitSeconds seconds="1.5"/>

      <MoveToNamedPose pose="ready"/>
      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/>

      <!-- <MoveToNamedPose pose="home"/>
      <WaitRealRobotSync tolerance="0.01" stable_time="0.5" timeout="30.0"/> -->
    </Sequence>
  </BehaviorTree>
</root>
